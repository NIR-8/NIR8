<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="light only"><title>NIR8 Calculators</title><script>MathJax={loader:{load:['input/tex','output/chtml']},tex:{inlineMath:[['$','$'],['\\(','\\)']],packages:{'[+]':['base','ams']},processEscapes:true},chtml:{scale:0.9,mtextInheritFont:true},startup:{typeset:false,pageReady(){MathJax.startup.defaultPageReady();document.dispatchEvent(new Event('MathJaxReady'))}}};</script><script src="decimal.min.js" onerror="loadDecimalFallback()"></script><script>function loadDecimalFallback(){console.warn('Local Decimal.js failed. Loading from CDN...');const e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js",e.async=!0,e.onerror=()=>{console.error("Failed to load Decimal.js"),alert("Unable to load Decimal.js. Check network or local file.")},e.onload=()=>{console.log("Decimal.js loaded"),initializeDecimal()},document.head.appendChild(e)}function initializeDecimal(){typeof Decimal!="undefined"&&Decimal.set({precision:20,toExpNeg:-9,toExpPos:20})}typeof Decimal!="undefined"&&initializeDecimal();</script><script src="assets/mathjax/es5/tex-mml-chtml.js" onerror="loadMathJaxFallback()" async></script><script>function loadMathJaxFallback(e=1,t=2){console.warn(`Local MathJax failed. Loading from CDN (${e}/${t})...`);const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js",n.async=!0,n.onerror=()=>{e<t?loadMathJaxFallback(e+1,t):(console.error("MathJax failed"),alert("Unable to load MathJax. Equations as text."),document.getElementById("mathjax-loading").textContent="Failed to load equations.",document.dispatchEvent(new Event('MathJaxReady')))},n.onload=()=>{console.log("MathJax loaded"),document.getElementById("mathjax-loading").style.display="none",MathJax.startup.getComponents()},document.head.appendChild(n)}</script><style>.CtxtMenu_Info{-webkit-border-radius:15px;-moz-border-radius:15px;border-radius:15px;-webkit-box-shadow:0 10px 20px #808080;-moz-box-shadow:0 10px 20px #808080;box-shadow:0 10px 20px #808080}.menu-bar{width:100%;background:rgba(0,0,0,.8);color:#fff;display:flex;justify-content:center;position:fixed;top:0;left:0;z-index:100;padding:10px 0}.menu-container{display:flex;max-width:1000px;width:100%;padding:0 20px;align-items:center;gap:20px}.menu-item{color:#fff;text-decoration:none;padding:8px 16px;margin:0 5px;border-radius:5px;transition:background .3s ease;cursor:pointer;white-space:nowrap}.menu-item:hover{background:rgba(255,255,255,.2)}.menu-item.active{background:#28a745}.menu-qty-tracker{display:flex;align-items:center;gap:15px;margin-left:auto}.menu-qty-tracker.hidden{display:none}.menu-qty-group{display:flex;flex-direction:column;align-items:flex-start}.menu-qty-input,.lot-select{width:100px;padding:5px;border:1px solid #ddd;border-radius:3px;text-align:center;background:#fff;color:#000;font-size:14px}.menu-qty-input:focus,.lot-select:focus{outline:0;border-color:#28a745}.lot-select option{background:#fff;color:#000}.menu-qty-label{font-size:12px;color:#ccc;margin-bottom:3px}.menu-qty-value{font-size:14px;font-weight:600;color:#fff}.menu-qty-warning{color:#ff6b6b;font-size:11px;margin-top:3px;display:none}.menu-qty-warning.active{display:block;background:#ff6b6b;color:#fff;padding:3px 8px;border-radius:3px;font-weight:600}body{font-family:Poppins,sans-serif;background:linear-gradient(to right,#4facfe,#00f2fe);display:flex;justify-content:center;align-items:center;min-height:100vh;flex-direction:column;padding:20px;text-align:center;margin:0;position:relative;padding-bottom:60px;padding-top:80px}.calculator-container{display:none;background:#fff;padding:25px;width:90%;max-width:400px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.2);margin-bottom:20px;position:relative}#acbCalculator{max-width:900px}.calculator-container.active{display:block}.input-group{margin-top:10px;text-align:left}label{font-weight:600;display:block;color:#444}input,select{width:calc(100% - 20px);padding:10px;margin:5px 0;border:2px solid #ddd;border-radius:5px;font-size:16px;text-align:center}input:focus,select:focus{border-color:#007bff;outline:0;box-shadow:0 0 5px rgba(0,123,255,.5)}.button-row{display:flex;gap:10px;justify-content:center;margin-top:15px}button{background:#28a745;color:#fff;padding:12px;flex:1;border:none;border-radius:5px;cursor:pointer;font-size:16px;user-select:none}button:hover{background:#218838}.hidden{display:none!important}.hidden[aria-hidden=true]{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.calculation-steps{margin-top:20px;padding:15px;width:90%;max-width:900px;background:#fff;border-radius:0;box-shadow:0 4px 10px rgba(0,0,0,.1);color:#555;text-align:left;position:relative;padding-top:20px;will-change:transform}.calculation-entry{margin-bottom:15px;border:1px solid #000;padding:15px;position:relative;width:100%;min-height:200px;font-size:14pt;border-radius:0;box-sizing:border-box;contain:content;overflow:hidden}.calculation-entry::before{content:"Assay Based Calculation";position:absolute;top:0;left:0;width:100%;background:#f0f0f0;padding:5mm;text-align:center;font-size:16pt;font-weight:600;border-bottom:1px solid #000;box-sizing:border-box}.calculation-entry::after{content:"Remarks: ______________________________________________________________";position:absolute;bottom:0;left:0;width:100%;background:#f0f0f0;padding:5mm;font-size:14pt;border-top:1px solid #000;box-sizing:border-box}.calculation-entry .lot-label::before{content:"LOT: ";position:absolute;top:24mm;left:15mm;font-size:14pt}.reference-values{position:absolute;top:24mm;right:15mm;font-size:10pt;color:#000;z-index:10}.calculation-content{margin-top:30mm;margin-bottom:30mm;padding:0 15mm;overflow:hidden;font-size:14pt}.delete-button{position:absolute;top:10px;left:10px;background:transparent;border:none;cursor:pointer;font-size:20px;color:red;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}.delete-button:hover{color:#c00}.page-number{position:absolute;bottom:1mm;right:4mm;font-size:8pt;color:#000;font-weight:700;z-index:5}.loading-indicator{display:none;position:absolute;top:10px;left:10px;font-size:12px;color:#666;font-style:italic}.input-row{display:flex;gap:10px;justify-content:space-between}.input-row .input-group{flex:1}.progress-container{width:100%;background:#ddd;border-radius:5px;margin-top:15px;height:10px;overflow:hidden}.progress-bar{width:0%;height:100%;background:#28a745;transition:width .3s ease-in-out}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}.acb-table{border-collapse:collapse;width:100%;margin:10px 0;font-family:Poppins,sans-serif;table-layout:auto}.acb-td,.acb-th{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px;min-width:60px;word-wrap:break-word;white-space:normal}.acb-th{background-color:#f2f2f2;color:#444;font-weight:600}.acb-input{width:calc(100% - 16px);padding:6px;margin:2px 0;border:2px solid #ddd;border-radius:5px;font-size:14px;text-align:center;background:transparent;transition:border-color .3s ease}.acb-input:focus{border-color:#00d403;outline:0;box-shadow:0 0 5px rgba(0,123,255,.5)}.acb-input.edited{border-color:#ffdc00ba;background-color:#fff}.acb-input[readonly]{background:#f5f5f5;cursor:not-allowed}.acb-span{display:block;padding:6px;font-size:14px}.acb-prefilled{color:#1a1a1a}.acb-manual-input,.acb-output{color:#00f}.acb-highlight-row{background-color:#e6f3ff}.acb-notice{text-align:center;background-color:#ffeb3b;padding:8px 16px;border-radius:5px;font-family:Poppins,sans-serif;font-size:14px;display:none;margin:10px auto;width:fit-content}.acb-toggle-btn{background:#28a745;color:#fff;padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-size:14px;transition:background .3s ease}.acb-toggle-btn:hover{background:#218838}.acb-toggle-btn:disabled{background:#ccc;cursor:not-allowed}.print-btn{background:#007bff;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:16px;margin-bottom:10px;display:none}.print-btn:hover{background:#0056b3}.calculation-steps:not(.hidden) .print-btn{display:block}.error-message{color:#ff6b6b;font-size:12px;margin-top:5px;text-align:center}.reset-acb-btn{position:absolute;bottom:10px;right:10px;background:transparent;border:none;cursor:pointer;font-size:20px;color:#ff6b6b;padding:5px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s ease}.reset-acb-btn:hover{background:rgba(255,107,107,.1);transform:rotate(90deg)}.info-modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1)}.close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer;user-select:none}.close:hover,.close:focus{color:#000;text-decoration:none;cursor:pointer}.info-section{margin-bottom:15px}.info-section h3{margin-top:0;color:#333;border-bottom:1px solid #ddd;padding-bottom:5px}.info-item{margin-bottom:8px}.info-key{font-weight:700;color:#28a745}.info-footer{text-align:center;margin-top:20px;font-size:12px;color:#777}#mathjax-loading{display:none;position:fixed;top:10px;right:10px;color:#666;font-size:14px;font-style:italic;z-index:1000}footer{width:100%;background:rgba(0,0,0,.8);color:#fff;text-align:center;padding:10px 0;position:fixed;bottom:0;left:0;font-size:14px;z-index:5}.info-btn{background:transparent;border:none;color:#ff9;cursor:pointer;font-weight:700;padding:0 5px;text-decoration:underline}.info-btn:hover{color:#fff}#remainingQty{cursor:pointer;transition:all .2s ease}#remainingQty:hover{color:#4facfe;text-decoration:underline}@media (max-width:768px){.calculation-entry{min-height:180px;font-size:12pt}.calculation-entry::before{font-size:14pt;padding:4mm}.calculation-entry::after{font-size:12pt;padding:4mm;bottom:8mm}.calculation-entry .lot-label::before,.reference-values{top:24mm;font-size:10pt}.calculation-content{margin-top:26mm;margin-bottom:26mm;font-size:12pt;padding:0 10mm}.page-number{font-size:10pt;bottom:2mm;right:10mm}.acb-td,.acb-th{font-size:12px;padding:6px;min-width:50px}.acb-input,.acb-span{font-size:12px;padding:4px}.menu-container{flex-wrap:wrap;gap:10px;padding:10px}.menu-qty-tracker{order:3;width:100%;justify-content:center;margin-left:0}}@media (max-width:480px){.calculation-entry{min-height:180px;font-size:10pt}.calculation-entry::before{font-size:12pt;padding:3mm}.calculation-entry::after{font-size:10pt;padding:3mm;bottom:6mm}.calculation-entry .lot-label::before{content:"LOT: ";position:absolute;top:20mm;left:8mm;font-size:10pt;width:100%;text-align:left;z-index:10}.reference-values{position:absolute;top:25mm;left:8mm;right:auto;font-size:10pt;text-align:left;width:100%;z-index:11}.calculation-content{margin-top:28mm;margin-bottom:22mm;font-size:10pt;padding:0 8mm}.page-number{font-size:8pt;bottom:1mm;right:8mm}.acb-td,.acb-th{font-size:10px;padding:4px;min-width:40px}.acb-input,.acb-span{font-size:10px;padding:3px}.calculator-container{width:100%;padding:15px}.acb-input,input{font-size:14px}.acb-toggle-btn,button{font-size:14px;padding:10px}.menu-item{padding:6px 10px;font-size:14px}.menu-qty-input,.lot-select{width:80px}}@media print{@page{size:A4 landscape;margin:5mm}body{background:transparent;padding:0;margin:0}#mathjax-loading,.acb-notice,.acb-toggle-btn,.calculator-container,.delete-button,.info-btn,.menu-bar,.print-btn,.progress-container,footer,.reset-acb-btn{display:none!important}.calculation-steps{border-radius:0!important;box-shadow:none!important;display:block!important;width:100%;max-width:none;margin:0;padding:0;box-shadow:none;background:transparent}.calculation-entry{border-radius:0!important;box-shadow:none!important;display:block!important;width:285mm;height:200mm;margin:0 auto;padding:0;box-sizing:border-box;page-break-after:always;border:1px solid #000;font-size:12pt;position:relative;background:#fff;overflow:hidden}.calculation-entry::before{content:"Assay Based Calculation";position:absolute;top:0;left:0;width:100%;background:#f0f0f0;padding:5mm;text-align:center;font-size:16pt;font-weight:600;border-bottom:1px solid #000;box-sizing:border-box}.calculation-entry::after{content:"Remarks: ______________________________________________________________";position:absolute;bottom:0;left:0;width:100%;background:#f0f0f0;padding:5mm;font-size:14pt;border-top:1px solid #000;box-sizing:border-box}.reference-values{position:absolute;top:20mm;right:10mm;font-size:10pt;color:#000;background:#fff;padding:2px 5px;z-index:10}.calculation-entry .lot-label::before{content:"LOT: ";position:absolute;top:24mm;left:15mm;font-size:14pt}.calculation-content{margin-top:30mm;margin-bottom:30mm;padding:0 15mm;font-size:14pt;overflow:hidden;text-align:left}.page-number{position:absolute;bottom:5mm;right:5mm;font-size:8pt;color:#000;font-weight:700}#stepsContainer{display:flex;flex-direction:column-reverse}}</style></head><body><div id="mathjax-loading">Loading equations...</div><noscript><div style="background:#ff6b6b;color:#fff;padding:10px;text-align:center">JavaScript is required to use this calculator. Please enable JavaScript in your browser settings.</div></noscript><div class="menu-bar"><div class="menu-container"><div class="menu-item active" id="menuFormula" onclick='showCalculator("formula")'>Formula Calculator</div><div class="menu-item" id="menuAcb" onclick='showCalculator("acb")'>(A+C)-B Calculator</div><div class="menu-qty-tracker"><div class="menu-qty-group"><label for="stdQty" class="menu-qty-label">Std Qty (kg)</label><input type="number" id="stdQty" class="menu-qty-input" step="0.001" min="0" placeholder="Enter std qty" onchange="updateQuantityTracker()"></div><div class="menu-qty-group"><label for="dispensedQty" class="menu-qty-label">Dispensed</label><div id="dispensedQty" class="menu-qty-value">0.000</div></div><div class="menu-qty-group"><label for="remainingQty" class="menu-qty-label">Remaining</label><div id="remainingQty" class="menu-qty-value">0.000</div><div id="quantityWarning" class="menu-qty-warning">Qty mismatch!</div></div><div class="menu-qty-group" id="lotSelectGroup" style="display:none"><label for="lotSelect" class="menu-qty-label">Select Lot</label><select id="lotSelect" class="lot-select"><option value="" disabled selected>Select Lot</option><option value="1">I</option><option value="2">II</option><option value="3">III</option><option value="4">IV</option></select></div></div></div></div><div id="formulaCalculator" class="calculator-container active"><h2>Formula Calculator</h2><div class="input-group"><label for="Q">Quantity (Q):</label><input type="number" id="Q" max="9999999" min="0.001" required placeholder="Enter quantity" oninput="handleInput(event)"></div><div class="input-row"><div class="input-group"><label for="water">Water Content (W):</label><input type="number" id="water" step="0.01" min="0.01" max="99.99" required placeholder="Enter water content" oninput="handleInput(event)"></div><div class="input-group"><label for="assay">Assay Content (A):</label><input type="number" id="assay" step="0.01" min="0.01" max="100.00" required placeholder="Enter assay content" oninput="handleInput(event)"></div></div><div class="progress-container"><div class="progress-bar" id="progressBar"></div></div><div class="button-row"><button type="button" onclick='calculate("F1")' aria-label="Calculate F1">Calculate F1</button><button type="button" onclick='calculate("F2")' aria-label="Calculate F2">Calculate F2</button><button type="button" onclick='calculate("F3")' aria-label="Calculate F3">Calculate F3</button></div></div><div id="acbCalculator" class="calculator-container"><div class="header-row"><h2>(A+C)-B Calculator</h2><button type="button" class="acb-toggle-btn" id="toggleEditBtn" onclick="toggleEdit()" aria-label="Toggle edit standard quantities">Enable Editing Std qty</button></div><table class="acb-table"><caption class="hidden">(A+C)-B Calculator Table</caption><thead><tr><th class="acb-th" scope="col"></th><th class="acb-th" scope="col">Lot-I</th><th class="acb-th" scope="col">Lot-II</th><th class="acb-th" scope="col">Lot-III</th><th class="acb-th" scope="col">Lot-IV</th><th class="acb-th" scope="col">TOTAL (kg)</th></tr></thead><tbody><tr><td class="acb-td">Std. Qty (A)<br>kg</td><td class="acb-td"><label for="lot1-a" class="hidden">Lot 1 Standard Quantity A</label><input type="number" step="0.001" id="lot1-a" value="417.000" class="acb-input acb-prefilled" readonly placeholder="Std Qty A"></td><td class="acb-td"><label for="lot2-a" class="hidden">Lot 2 Standard Quantity A</label><input type="number" step="0.001" id="lot2-a" value="417.000" class="acb-input acb-prefilled" readonly placeholder="Std Qty A"></td><td class="acb-td"><label for="lot3-a" class="hidden">Lot 3 Standard Quantity A</label><input type="number" step="0.001" id="lot3-a" value="417.000" class="acb-input acb-prefilled" readonly placeholder="Std Qty A"></td><td class="acb-td"><label for="lot4-a" class="hidden">Lot 4 Standard Quantity A</label><input type="number" step="0.001" id="lot4-a" value="417.000" class="acb-input acb-prefilled" readonly placeholder="Std Qty A"></td><td class="acb-td"><span id="total-a" class="acb-span acb-prefilled">1668.000</span></td></tr><tr class="acb-highlight-row"><td class="acb-td">Issued Qty (B)<br>kg</td><td class="acb-td"><label for="lot1-b" class="hidden">Lot 1 Issued Quantity B</label><input type="number" step="0.001" id="lot1-b" class="acb-input" placeholder="Issued Qty B"></td><td class="acb-td"><label for="lot2-b" class="hidden">Lot 2 Issued Quantity B</label><input type="number" step="0.001" id="lot2-b" class="acb-input" placeholder="Issued Qty B"></td><td class="acb-td"><label for="lot3-b" class="hidden">Lot 3 Issued Quantity B</label><input type="number" step="0.001" id="lot3-b" class="acb-input" placeholder="Issued Qty B"></td><td class="acb-td"><label for="lot4-b" class="hidden">Lot 4 Issued Quantity B</label><input type="number" step="0.001" id="lot4-b" class="acb-input" placeholder="Issued Qty B"></td><td class="acb-td"><span id="total-b" class="acb-span acb-prefilled">0.000</span></td></tr><tr><td class="acb-td">Std. Qty (C)<br>kg</td><td class="acb-td"><label for="lot1-c" class="hidden">Lot 1 Standard Quantity C</label><input type="number" step="0.001" id="lot1-c" value="84.375" class="acb-input acb-prefilled" readonly placeholder="Std Qty C"></td><td class="acb-td"><label for="lot2-c" class="hidden">Lot 2 Standard Quantity C</label><input type="number" step="0.001" id="lot2-c" value="84.375" class="acb-input acb-prefilled" readonly placeholder="Std Qty C"></td><td class="acb-td"><label for="lot3-c" class="hidden">Lot 3 Standard Quantity C</label><input type="number" step="0.001" id="lot3-c" value="84.375" class="acb-input acb-prefilled" readonly placeholder="Std Qty C"></td><td class="acb-td"><label for="lot4-c" class="hidden">Lot 4 Standard Quantity C</label><input type="number" step="0.001" id="lot4-c" value="84.375" class="acb-input acb-prefilled" readonly placeholder="Std Qty C"></td><td class="acb-td"><span id="total-c" class="acb-span acb-prefilled">337.500</span></td></tr><tr class="acb-highlight-row"><td class="acb-td">(A+C)-(B)<br>kg</td><td class="acb-td"><span id="lot1-result">-</span></td><td class="acb-td"><span id="lot2-result">-</span></td><td class="acb-td"><span id="lot3-result">-</span></td><td class="acb-td"><span id="lot4-result">-</span></td><td class="acb-td"><span id="total-result" class="acb-span acb-prefilled">0.000</span></td></tr></tbody></table><div id="acb-notice" class="acb-notice">You are editing standard values.</div><button type="button" class="reset-acb-btn" onclick="resetACBCalculator()" title="Reset (A+C)-B Calculator" aria-label="Reset (A+C)-B Calculator">↻</button></div><div class="calculation-steps hidden" id="calculationSteps" role="region" aria-label="Calculation steps"><button type="button" onclick="printWithCheck()" class="print-btn" aria-label="Print calculations">Print Calculations</button><div id="stepsContainer"></div></div><div id="infoModal" class="info-modal"><div class="modal-content"><span class="close" onclick="closeModal()" aria-label="Close information modal">×</span><div id="formulaInfo" class="info-section"><h3>Formula Calculator-Shortcuts</h3><div class="info-item"><span class="info-key">F1/F2/F3:</span>Calculate respective formulas</div><div class="info-item"><span class="info-key">F4:</span>Print calculations</div><div class="info-item"><span class="info-key">❌:</span>Remove individual calculations</div><div class="info-item"><span class="info-key">F5:</span>Clear All (formula calculations)</div><div class="info-item"><span class="info-key">F8:</span>Clear inputs only</div><div class="info-item"><span class="info-key">Enter:</span>Navigate between fields</div><div class="info-item"><span class="info-key">Click Remaining Qty:</span>Copy to Q field</div></div><div id="acbInfo" class="info-section" style="display:none"><h3>(A+C)-B Calculator Features</h3><div class="info-item"><span class="info-key">Edit Button:</span>Toggle editing of standard quantities</div><div class="info-item"><span class="info-key">Enter:</span>Navigate between editable fields</div><div class="info-item"><span class="info-key">Auto-update:</span>Changes automatically update totals</div><div class="info-item"><span class="info-key">Reset Button (↻):</span>Reset all values in this calculator</div><div class="info-item"><span class="info-key">Lot Select:</span>Assign dispensed qty to selected lot</div></div><div class="info-footer">This tool is continuously improving to serve you better.</div></div></div><footer>This tool is continuously improving to serve you better. Results are reliable but always double-check. <button type="button" class="info-btn" onclick="showInfo()" aria-label="Show help and shortcuts">ℹ️ Click for Help & Shortcuts</button></footer><script>const C={MAX_CALCULATIONS:15,ACB_DEFAULT_A:417,ACB_DEFAULT_C:84.375,ACB_TOTAL_A:1668,ACB_TOTAL_C:337.5,Q_MAX:9999999,W_MAX:99.99,A_MAX:100,MATHJAX_TIMEOUT:1e4,LOTS:["I","II","III","IV"]};Decimal.set({precision:20,toExpNeg:-9,toExpPos:20});const D={QInput:document.getElementById("Q"),waterInput:document.getElementById("water"),assayInput:document.getElementById("assay"),waterGroup:document.querySelector("#water").parentElement,assayGroup:document.querySelector("#assay").parentElement,buttons:document.querySelector(".button-row"),progressBar:document.getElementById("progressBar"),calculationSteps:document.getElementById("calculationSteps"),stepsContainer:document.getElementById("stepsContainer"),formulaCalculator:document.getElementById("formulaCalculator"),acbCalculator:document.getElementById("acbCalculator"),menuFormula:document.getElementById("menuFormula"),menuAcb:document.getElementById("menuAcb"),toggleEditBtn:document.getElementById("toggleEditBtn"),acbNotice:document.getElementById("acb-notice"),mathJaxLoading:document.getElementById("mathjax-loading"),stdQtyInput:document.getElementById("stdQty"),dispensedQty:document.getElementById("dispensedQty"),remainingQty:document.getElementById("remainingQty"),quantityWarning:document.getElementById("quantityWarning"),lotSelect:document.getElementById("lotSelect"),lotSelectGroup:document.getElementById("lotSelectGroup"),acbInputs:{a:["lot1-a","lot2-a","lot3-a","lot4-a"].map(e=>document.getElementById(e)),b:["lot1-b","lot2-b","lot3-b","lot4-b"].map(e=>document.getElementById(e)),c:["lot1-c","lot2-c","lot3-c","lot4-c"].map(e=>document.getElementById(e)),results:["lot1-result","lot2-result","lot3-result","lot4-result"].map(e=>document.getElementById(e)),totals:{a:document.getElementById("total-a"),b:document.getElementById("total-b"),c:document.getElementById("total-c"),result:document.getElementById("total-result")}}};let calculationCount=0,isMathJaxReady=!1,hasCalculated=!1,isACBEditingEnabled=!1,acbNoticeTimeout,calculationsByLot=Array(4).fill().map(()=>[]),currentLot=0,mathJaxQueue=[],mathJaxPending=!1;document.addEventListener("MathJaxReady",()=>{isMathJaxReady=!0,D.mathJaxLoading.style.display="none",MathJax.typesetPromise().then(()=>{document.querySelectorAll(".calculation-entry").forEach(e=>{const t=e.querySelector(".calculation-content"),n=e.querySelector(".reference-values");if(t&&n){const r=n.getBoundingClientRect(),o=t.getBoundingClientRect();r.bottom>o.top&&(t.style.marginTop=`${parseFloat(t.style.marginTop||"35")+5}mm`)}})}).catch(e=>console.error("MathJax initial typeset error:",e))});function retryMathJaxLoad(e=1,t=2){if(e>t)return alert("Failed to render equations. Displaying plain text."),isMathJaxReady=!0,void(D.mathJaxLoading.style.display="none");const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js",n.async=!0,n.onload=()=>{MathJax.startup.getComponents(),isMathJaxReady=!0,D.mathJaxLoading.style.display="none",MathJax.typesetPromise().catch(e=>{console.error(`MathJax retry ${e} typeset error:`,e),retryMathJaxLoad(e+1,t)})},n.onerror=()=>retryMathJaxLoad(e+1,t),document.head.appendChild(n)}function truncateTo12Digits(e){try{const t=new Decimal(e).toString(),n=t.startsWith("-"),r=n?t.slice(1):t;let o=n?"-":"",i=0;for(let e=0;e<r.length&&i<12;e++)r[e]==="."?o+=".":(o+=r[e],i++);return o}catch{return e.toString()}}function formatNumber(e,t){const n=`${e}_${t}`;if(formatNumber.cache||(formatNumber.cache=new Map),formatNumber.cache.size>=500&&formatNumber.cache.clear(),formatNumber.cache.has(n))return formatNumber.cache.get(n);try{const r=new Decimal(e),o=t?r.toFixed(2):r.toString(),i=truncateTo12Digits(o);return formatNumber.cache.set(n,i),i}catch{return e.toString()}}function queueMathJax(e){mathJaxQueue.push(e),mathJaxPending||(mathJaxPending=!0,requestAnimationFrame(()=>{MathJax.typesetPromise(mathJaxQueue).then(()=>{mathJaxPending=!1,mathJaxQueue=[]}).catch(e=>{console.error("MathJax error:",e),mathJaxPending=!1,mathJaxQueue=[],retryMathJaxLoad()})}))}function createCalculation(e,t,n,r){try{const o=new Decimal(100),i=formatNumber(t),a=formatNumber(r,!0),s=formatNumber(n,!0);if(e==="F1"||e==="F3"){const e=t.mul(o),u=e.mul(o),c=o.minus(n),l=r.mul(c);if(l.isZero())throw new Error("Division by zero");const d=u.div(l),h=d.toFixed(3);return{mathJax:`$$ F_${e==="F1"?"1":"3"} = \\frac{${i} \\times 100 \\times 100}{${a} \\times (100 - ${s})} $$ <br><br>$$ = \\frac{${i} \\times 100 \\times 100}{${a} \\times ${formatNumber(c)}} $$ <br><br>$$ = \\frac{${formatNumber(u)}}{${formatNumber(l)}} $$ <br><br>$$ = ${truncateTo12Digits(h)} \\text{ (original: } ${formatNumber(d)} \\text{)} $$`,plainText:`F${e==="F1"?"1":"3"} = (${i} × 100 × 100) / (${a} × (100 - ${s}))<br><br>= (${i} × 100 × 100) / (${a} × ${formatNumber(c)})<br><br>= ${formatNumber(u)} / ${formatNumber(l)}<br><br>= ${truncateTo12Digits(h)} <br> (original: ${formatNumber(d)})`,formulaType:e,Q:t.toString(),W:n.toString(),A:r.toString(),result:h,isFinal:!0}}else if(e==="F2"){const e=o.minus(n),u=r.mul(e),a=t.mul(u),s=o.mul(o),c=a.div(s),l=c.toFixed(3);return{mathJax:`$$ F_2 = \\frac{${i} \\times ${a} \\times (100 - ${s})}{100 \\times 100} $$ <br><br>$$ = \\frac{${i} \\times ${a} \\times ${formatNumber(e)}}{${formatNumber(s)}} $$ <br><br>$$ = \\frac{${formatNumber(a)}}{${formatNumber(s)}} $$ <br><br>$$ = ${truncateTo12Digits(l)} \\text{ (original: } ${formatNumber(c)} \\text{)} $$`,plainText:`F2 = (${i} × ${a} × (100 - ${s})) / (100 × 100)<br><br>= (${i} × ${a} × ${formatNumber(e)}) / ${formatNumber(s)}<br><br>= ${formatNumber(a)} / ${formatNumber(s)}<br><br>= ${truncateTo12Digits(l)} <br> (original: ${formatNumber(c)})`,formulaType:e,Q:t.toString(),W:n.toString(),A:r.toString(),result:l,isFinal:!1}}}catch(e){console.error("Calculation error:",e),throw e}}function updateQuantityTracker(){const e=new Decimal(D.stdQtyInput.value||0);let t=new Decimal(0),n=new Decimal(0),r=!1,o=!1;calculationsByLot.forEach(e=>{e.forEach(e=>{e.formulaType==="F2"?(t=t.plus(e.Q),n=n.plus(e.result),o=!0):(e.formulaType==="F1"||e.formulaType==="F3")&&(t=t.plus(e.result),n=n.plus(e.Q),r=!0)})}),D.dispensedQty.textContent=formatNumber(t),e.isZero()||!D.stdQtyInput.value.trim()?(D.remainingQty.textContent="-",D.quantityWarning.classList.remove("active"),D.lotSelectGroup.style.display="none"):(a=e.minus(n),D.remainingQty.textContent=formatNumber(a),a.eq(0)&&(currentLot<C.LOTS.length-1?(currentLot++,D.lotSelect.value=currentLot+1,updateLotDispensedQty()):D.lotSelectGroup.style.display="block"),D.lotSelectGroup.style.display=a.eq(0)?"block":"none");const i=calculationsByLot[currentLot].length>0?calculationsByLot[currentLot][calculationsByLot[currentLot].length-1].formulaType:null,a=e.minus(n),s=i==="F1"||i==="F3";(r&&!a.eq(0)||o&&a.lte(0)&&!(s&&a.eq(0)))&&D.quantityWarning.classList.add("active")}function updateLotDispensedQty(){const e=parseInt(D.lotSelect.value)-1;if(e>=0&&e<D.acbInputs.b.length){const t=D.dispensedQty.textContent,n=D.acbInputs.b[e];n.value=t,n.classList.add("acb-manual-input"),updateACB(n,e,"b"),showCalculator("acb"),n.focus(),D.lotSelect.value="",D.lotSelectGroup.style.display="none"}}function copyRemainingToQ(){D.remainingQty.textContent!=="-"&&D.remainingQty.textContent!=="0.000"&&confirm(`Copy ${D.remainingQty.textContent} to Quantity (Q) field? This will clear current inputs.`)&&(D.QInput.value=D.remainingQty.textContent,D.waterInput.value="",D.assayInput.value="",D.progressBar.style.width="33%",D.buttons.style.display="none",D.assayGroup.style.display="block",D.QInput.focus())}function resetACBCalculator(){if(!confirm("Are you sure you want to reset the (A+C)-B calculator? This will clear all entered values."))return;D.acbInputs.a.forEach(e=>{e.value=C.ACB_DEFAULT_A.toFixed(3),e.classList.remove("edited","acb-manual-input"),e.classList.add("acb-prefilled")}),D.acbInputs.c.forEach(e=>{e.value=C.ACB_DEFAULT_C.toFixed(3),e.classList.remove("edited","acb-manual-input"),e.classList.add("acb-prefilled")}),D.acbInputs.b.forEach(e=>{e.value="",e.classList.remove("acb-manual-input")}),D.acbInputs.totals.a.textContent=C.ACB_TOTAL_A.toFixed(3),D.acbInputs.totals.b.textContent="0.000",D.acbInputs.totals.c.textContent=C.ACB_TOTAL_C.toFixed(3),D.acbInputs.totals.result.textContent="0.000",D.acbInputs.results.forEach(e=>{e.textContent="-",e.classList.remove("acb-output","acb-prefilled")}),isACBEditingEnabled&&toggleEdit()}function calculate(e){if(calculationCount>=C.MAX_CALCULATIONS)return alert(`Maximum of ${C.MAX_CALCULATIONS} calculations reached. Press F5 to reset or delete a calculation.`),void 0;let t,n,r;try{t=new Decimal(D.QInput.value||0),n=new Decimal(D.waterInput.value||0),r=new Decimal(D.assayInput.value||0)}catch{return void alert("Invalid input values.")}if(t.isNaN()||n.isNaN()||r.isNaN()||t.lte(0)||n.lte(0)||r.lte(0))return void alert("Please enter valid values for Q, W, and A (all must be greater than 0).");if(t.gt(C.Q_MAX))return void alert(`Quantity (Q) must be less than or equal to ${C.Q_MAX}.`);if(r.gt(C.A_MAX)||n.gt(C.W_MAX))return void alert("Invalid values: Ensure A ≤ 100 and W ≤ 99.99.");hasCalculated=!0;let o;try{o=createCalculation(e,t,n,r),o||(new Error("Failed to create calculation"))}catch{return void alert("Calculation failed. Please check inputs.")}calculationsByLot[currentLot].push(o),calculationCount++,updateCalculationDisplay(),updateQuantityTracker()}function updateCalculationDisplay(){D.stepsContainer.innerHTML="",calculationsByLot.forEach((e,t)=>{if(e.length>0){const n=document.createElement("div");n.className="lot-header",n.textContent=`Lot ${C.LOTS[t]}`,D.stepsContainer.appendChild(n),e.forEach((e,n)=>{const r=document.createElement("div");r.className="calculation-entry",r.setAttribute("tabindex","0"),r.setAttribute("aria-label",`Calculation ${e.formulaType} for Lot ${C.LOTS[t]}`),r.innerHTML=`<button type="button" class="delete-button" onclick="deleteCalculation(this)" title="Delete" aria-label="Delete calculation">❌</button><div class="lot-label">Lot ${C.LOTS[t]}</div><div class="reference-values">W="${formatNumber(e.W,!0)}" A="${formatNumber(e.A,!0)}"</div><div class="calculation-content">${e.plainText}</div><div class="page-number">${n+1}/${e.length}</div>${!isMathJaxReady?'<span class="loading-indicator">Rendering...</span>':""}`,D.stepsContainer.appendChild(r),isMathJaxReady&&setTimeout(()=>{r.querySelector(".calculation-content").innerHTML=e.mathJax,queueMathJax(r)},50)})}}),D.calculationSteps.classList.toggle("hidden",calculationCount===0),calculationCount>0&&setTimeout(()=>{D.stepsContainer.scrollTop=D.stepsContainer.scrollHeight},100)}function handleInput(e){const t=e.target,n=t.value.trim();let r;const o=t.nextElementSibling?.classList.contains("error-message")?t.nextElementSibling:null;try{r=parseFloat(n)}catch{return showError(t,"Enter a valid number."),void 0}if(n==="")return clearError(t),updateProgress(),void 0;if(t.id==="water"||t.id==="assay"){if(!/^\d*\.?\d{0,2}$/.test(n))return t.value=n.slice(0,-1),void 0;if(isNaN(r)||r<=0)return showError(t,`${t.id==="water"?"Water Content (W)":"Assay Content (A)"} must be greater than 0.`),void 0;if(r>100)return t.value="",showError(t,`${t.id==="water"?"Water Content (W)":"Assay Content (A)"} cannot exceed 100.00.`),alert(`${t.id==="water"?"Water Content (W)":"Assay Content (A)"} cannot exceed 100.00.`),t.focus(),void 0;clearError(t)}if(e.key==="Enter"&&n!==""){e.preventDefault();const e=t.id==="Q"?D.waterInput:t.id==="water"?D.assayInput:null;e?(e.parentElement.style.display="block",e.focus()):t.blur()}if(e.type==="change"&&t.id==="water"){if(r>20&&r<=100)return confirm("Water content seems high (>20). Swap with assay content?")?(D.assayInput.value=t.value,t.value="",void t.focus()):(t.focus(),void 0);t.value=r.toFixed(2),D.assayInput.focus()}hasCalculated&&(t.id==="water"||t.id==="assay")&&(t.id==="assay"&&r<10&&r>0?showError(t,"Assay Content (A) should be greater than 80."):t.id==="water"&&r>80&&r<=100&&showError(t,"Water Content (W) should be less than 10.")),updateProgress()}function showError(e,t){clearError(e);const n=document.createElement("div");n.className="error-message",n.id=`${e.id}-error`,n.textContent=t,e.parentElement.appendChild(n),e.setAttribute("aria-describedby",n.id),e.setCustomValidity(t),e.reportValidity()}function clearError(e){const t=e.nextElementSibling?.classList.contains("error-message")?e.nextElementSibling:null;t&&t.remove(),e.removeAttribute("aria-describedby"),e.setCustomValidity("")}function updateProgress(){let e=0;D.QInput.value.trim()&&e++,D.waterInput.value.trim()&&e++,D.assayInput.value.trim()&&e++,D.progressBar.style.width=e/3*100+"%",D.waterGroup.style.display=D.QInput.value.trim()?"block":"none",D.assayGroup.style.display=D.waterInput.value.trim()?"block":"none",D.buttons.style.display=e===3?"flex":"none"}function showCalculator(e){D.formulaCalculator.classList.toggle("active",e==="formula"),D.acbCalculator.classList.toggle("active",e==="acb"),D.menuFormula.classList.toggle("active",e==="formula"),D.menuAcb.classList.toggle("active",e==="acb"),D.menuQtyTracker.classList.toggle("hidden",e==="acb"),D.calculationSteps.classList.toggle("hidden",e!=="formula"||calculationCount===0),(e==="formula"?D.QInput:D.acbInputs.b[0]).focus()}function showInfo(){const e=document.getElementById("infoModal"),t=document.getElementById("formulaInfo"),n=document.getElementById("acbInfo");t.style.display=D.formulaCalculator.classList.contains("active")?"block":"none",n.style.display=D.formulaCalculator.classList.contains("active")?"none":"block",e.style.display="block",document.querySelector(".close").focus()}function closeModal(){document.getElementById("infoModal").style.display="none",(D.formulaCalculator.classList.contains("active")?D.QInput:D.acbInputs.b[0]).focus()}function clearAllFields(){if(!confirm("Are you sure you want to clear all calculations and proceed to next lot?"))return;D.stepsContainer.innerHTML="",D.calculationSteps.classList.add("hidden"),D.QInput.value="",D.waterInput.value="",D.assayInput.value="",D.progressBar.style.width="0%",D.buttons.style.display="none",D.assayGroup.style.display="none",D.waterGroup.style.display="none",D.QInput.focus(),updateQuantityTracker()}function clearInputsOnly(){if(!confirm("Are you sure you want to clear all input fields in the formula calculator?"))return;D.QInput.value="",D.waterInput.value="",D.assayInput.value="",D.progressBar.style.width="0%",D.buttons.style.display="none",D.assayGroup.style.display="none",D.waterGroup.style.display="none",updateQuantityTracker(),D.QInput.focus()}function deleteCalculation(e){if(!confirm("Are you sure you want to delete this calculation?"))return;const t=e.parentElement,n=Array.from(D.stepsContainer.querySelectorAll(".calculation-entry")),r=n.indexOf(t);let o=!1;calculationsByLot.forEach((e,t)=>{if(!o&&t.textContent.includes(`Lot ${C.LOTS[t]}`)){const n=Array.from(D.stepsContainer.querySelectorAll(`.calculation-entry:contains("Lot ${C.LOTS[t]}")`)).indexOf(t);n>=0&&n<e.length&&(e.splice(n,1),calculationCount--,o=!0)}}),t.remove(),calculationCount===0&&D.calculationSteps.classList.add("hidden"),updateCalculationDisplay(),updateQuantityTracker(),D.QInput.focus()}function updatePageNumbers(){const e=D.stepsContainer.getElementsByClassName("calculation-entry"),t=e.length;Array.from(e).forEach((e,n)=>{const r=e.querySelector(".page-number");r&&(r.textContent=`${t-n}/${t}`)})}function validateInput(e){const t=e.value;(e.id==="stdQty"||e.id.includes("-b")?3:2),!/^\d*\.?\d{0,3}$/.test(t)&&t!==""&&(e.value=t.slice(0,-1))}function toggleEdit(){isACBEditingEnabled=!isACBEditingEnabled,D.toggleEditBtn.textContent=isACBEditingEnabled?"Disable Edit":"Enable Edit",D.acbInputs.a.concat(D.acbInputs.c).forEach(e=>{e.readOnly=!isACBEditingEnabled}),isACBEditingEnabled&&showACBNotice()}function showACBNotice(){D.acbNotice.style.display="block",clearTimeout(acbNoticeTimeout),acbNoticeTimeout=setTimeout(()=>{D.acbNotice.style.display="none"},3e3)}function updateACB(e,t,n){try{const r=new Decimal(e.value||0);if(n==="a"||n==="c"){const o=new Decimal(n==="a"?C.ACB_DEFAULT_A:C.ACB_DEFAULT_C);e.classList.toggle("edited",!r.eq(o)),e.classList.remove("acb-prefilled"),e.classList.add("acb-manual-input"),t===0&&D.acbInputs[n].slice(1).forEach((e,t)=>{e.value=formatNumber(r),e.classList.toggle("edited",!r.eq(o)),e.classList.remove("acb-manual-input"),e.classList.add("acb-prefilled")})}else e.classList.add("acb-manual-input")}catch{e.value=""}let o=new Decimal(0),i=new Decimal(0),a=new Decimal(0),s=new Decimal(0);D.acbInputs.a.forEach((e,n)=>{const r=new Decimal(e.value||0),c=new Decimal(D.acbInputs.b[n].value||0),l=new Decimal(D.acbInputs.c[n].value||0),d=D.acbInputs.results[n];if(c.isZero()||!D.acbInputs.b[n].value.trim())d.textContent="-",d.classList.remove("acb-output","acb-prefilled");else{const e=r.plus(l).minus(c);d.textContent=formatNumber(e),d.classList.add("acb-output"),d.classList.remove("acb-prefilled"),s=s.plus(e)}o=o.plus(r),i=i.plus(c),a=a.plus(l)}),D.acbInputs.totals.a.textContent=formatNumber(o),D.acbInputs.totals.b.textContent=formatNumber(i),D.acbInputs.totals.c.textContent=formatNumber(a),D.acbInputs.totals.result.textContent=formatNumber(s),[D.acbInputs.totals.a,D.acbInputs.totals.b,D.acbInputs.totals.c].forEach(e=>{e.classList.add("acb-output"),e.classList.remove("acb-prefilled")}),D.acbInputs.totals.result.classList.toggle("acb-prefilled",s.isZero()),D.acbInputs.totals.result.classList.toggle("acb-output",!s.isZero())}function printWithCheck(){window.innerWidth<=768&&!confirm("For optimal printing, use a larger screen or PC. Continue?")||window.print()}document.addEventListener("DOMContentLoaded",()=>{D.assayGroup.style.display="none",D.waterGroup.style.display="none",D.buttons.style.display="none",D.calculationSteps.classList.add("hidden"),D.QInput.focus(),[D.QInput,D.waterInput,D.assayInput].forEach(e=>{e.addEventListener("input",e=>{validateInput(e.target),handleInput(e)}),e.addEventListener("keydown",e=>{(e.key==="ArrowUp"||e.key==="ArrowDown")&&e.preventDefault(),e.key==="Enter"&&handleInput(e)}),e.addEventListener("contextmenu",e=>e.preventDefault())}),D.acbCalculator.addEventListener("input",e=>{const t=e.target,n=t.id.match(/lot(\d+)-([abc])/);if(n){const[,r,o]=n;validateInput(t),updateACB(t,parseInt(r)-1,o),(o==="a"||o==="c")&&isACBEditingEnabled&&showACBNotice()}});const e=["a","b","c"].flatMap(e=>[1,2,3,4].map(t=>`lot${t}-${e}`));e.forEach((e,t)=>{const n=document.getElementById(e);n&&n.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();let r=t+1;for(;r<e.length;){if(r>=e.length&&(r=0),!1)break;const t=document.getElementById(e[r]);if(t&&!t.readOnly)return void t.focus();r++}}})}),window.addEventListener("click",e=>{e.target===document.getElementById("infoModal")&&closeModal()}),document.addEventListener("keydown",e=>{switch(e.key){case"F1":e.preventDefault(),calculate("F1");break;case"F2":e.preventDefault(),calculate("F2");break;case"F3":e.preventDefault(),calculate("F3");break;case"F4":e.preventDefault(),calculationCount>0&&printWithCheck();break;case"F5":e.preventDefault(),clearAllFields();break;case"F8":e.preventDefault(),clearInputsOnly()}}),D.stdQtyInput.addEventListener("input",()=>{validateInput(D.stdQtyInput),updateQuantityTracker()}),D.remainingQty.addEventListener("click",copyRemainingToQ),D.lotSelect.addEventListener("change",updateLotDispensedQty),updateQuantityTracker(),isMathJaxReady||(D.mathJaxLoading.style.display="block",setTimeout(()=>{isMathJaxReady||retryMathJaxLoad()},C.MATHJAX_TIMEOUT)),window.addEventListener("beforeunload",e=>{calculationCount>0&&(e.preventDefault(),e.returnValue="You have unsaved calculations. Are you sure you want to leave?")})}),window.addEventListener("resize",updatePageNumbers);</script></body></html>
